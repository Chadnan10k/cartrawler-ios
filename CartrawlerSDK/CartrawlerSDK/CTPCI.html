<html>
    
    <!--
     lmaguire@cartrawler.com
     
     HowTo: So the payment for MUST be loaded into an iFrame, we then create a listen for the parent view, UIWebView & WebView can then listen for messages through delegates.
     
     Timeline of events:
     
     IFrame created -> OnLoad triggered -> msg payload sent from native app with postMessage -> from validation success / error callback -> payment success / fail callback -> ðŸ˜Ž Finish
     
     -->
    <head>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    </head>
    <iframe id="ct-secure-payment"  src="[URLPLACEHOLDER]"> </iframe>
    
    <script>
        
        $(document).ready(function () {
                          
                          
          $("iframe").load(function() {
                           var frameContents;
                           frameContents = $("#ct-secure-payment").contents();
                           frameContents.find("#ct-container").css("background-color","#EFEFF4");
                           });
        });

      var currentState = "";
      var securePaymentWin = document.getElementById("ct-secure-payment").contentWindow;
      var eventMethod = window.addEventListener ? "addEventListener" : "attachEvent";
      var eventer = window[eventMethod];
      var messageEvent = eventMethod == "attachEvent" ? "onmessage" : "message";
      
      //enum obj-c / java
      /*
       currentState:
       
       Loading
       Loaded
       Tag
       SendingPayment
       PaymentError
       ValidationError
       
       */
      
      // Listen to message from child window
      eventer(messageEvent,function(e) {
          var paymentFormMsg = JSON.parse(e.data);
          if (paymentFormMsg.action === "onLoad") {
          //currentState = "Loaded";
          
          }
          if (paymentFormMsg.action === "tag") {
          //currentState = "Tag";
          }
          if (paymentFormMsg.action === "sendMessage") {
            currentState = "SendingPayment";
          }
          if (paymentFormMsg.action === "sendError") {
            currentState = "PaymentError";
          }
          if (paymentFormMsg.action === " validation") {
            currentState = "ValidationError";
          }
          if (paymentFormMsg.action === "onError") {
            currentState = "PaymentError"
          }
      },false);
      
      function getCurrentState() {
          return currentState;
      }
      
      function generateMessage(jsonPayload) {
          return encodeURIComponent(JSON.stringify(jsonPayload));
      }
      
      function validateAndBook() {
          securePaymentWin.postMessage({"action" : "submitForm"} , "*");
      }
    
                          
        </script>
    
    <style>
        #ct-secure-payment {
            height: 100%;
            width: 100%;
            border: 0px;
        }
    
    body {
        background-color: #EFEFF4;
    }
    
        </style>
    
</html>
